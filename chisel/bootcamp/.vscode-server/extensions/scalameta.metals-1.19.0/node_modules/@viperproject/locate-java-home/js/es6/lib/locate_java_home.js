import { existsSync } from 'fs';
import { resolve as resolvePath } from 'path';
import { exec } from 'child_process';
import { satisfies as semverSatisfies } from 'semver';
import { each as asyncEach } from 'async';
import Platform from './platform';
const defaultOptions = {
    version: "*",
    mustBeJDK: false,
    mustBeJRE: false,
    paranoid: false,
    mustBe64Bit: false
};
/**
 * Return an ILocateJavaHomeOptions object with defaults filled in.
 */
function fillInDefaults(opts) {
    // semver standardization
    if (opts.version === 'any') {
        opts.version = "*";
    }
    return Object.assign({}, defaultOptions, opts);
}
function locateJavaHome(arg1, arg2) {
    let options = defaultOptions;
    let cb = arg1;
    if (arg2) {
        cb = arg2;
        options = fillInDefaults(arg1);
    }
    // Sanity check
    if (options.mustBeJDK && options.mustBeJRE) {
        return cb(new Error(`Unsatisfiable options: A JAVA_HOME cannot be both a JDK and not a JDK.`), []);
    }
    const locateJavaHome = Platform(process.platform);
    locateJavaHome().then((res) => {
        const homeInfos = [];
        // NOTE: We don't use async.map here because we want to be error tolerant
        // in case some of the JAVA_HOME locations are erroneous.
        asyncEach(res.homes, (home, asyncCb) => {
            getJavaHomeInfo(home, res.executableExtension, (err, homeInfo) => {
                if (!err) {
                    // Push the info and continue iteration.
                    homeInfos.push(homeInfo);
                    asyncCb();
                }
                else if (options.paranoid) {
                    // Report the error, halting iteration.
                    asyncCb(err);
                }
                else {
                    // Ignore JAVA_HOME.
                    asyncCb();
                }
            });
        }, (err) => {
            var seenPaths = {};
            if (err) {
                cb(err);
            }
            else {
                cb(null, homeInfos
                    .filter((homeInfo) => {
                    // Absolute pathify.
                    homeInfo.path = resolvePath(homeInfo.path);
                    // Filter redundant paths.
                    if (seenPaths[homeInfo.path]) {
                        return false;
                    }
                    else {
                        seenPaths[homeInfo.path] = true;
                    }
                    // JDK constraint
                    return (!options.mustBeJDK || homeInfo.isJDK)
                        // JRE constraint
                        && (!options.mustBeJRE || !homeInfo.isJDK)
                        // 64-bit constraint
                        && (!options.mustBe64Bit || homeInfo.is64Bit)
                        // version constraint
                        && semverSatisfies(homeInfo.version, options.version);
                }).sort((a, b) => a.path.localeCompare(b.path)));
            }
        });
    });
}
/**
 * Get the IJavaHomeInfo object for the given path.
 */
function getJavaHomeInfo(home, executableExtension, cb) {
    const javaPath = getBinaryPath(home, 'java', executableExtension);
    const javacPath = getBinaryPath(home, 'javac', executableExtension);
    if (!javaPath) {
        return cb(new Error(`Unable to locate 'java' executable in path ${home}`));
    }
    getJavaVersionAndDataModel(javaPath, (err, version, security, is64Bit) => {
        if (err) {
            cb(err);
        }
        else {
            let info = {
                path: home,
                version: version,
                security: security,
                isJDK: javacPath !== null,
                is64Bit: is64Bit,
                executables: {
                    java: javaPath
                }
            };
            if (javacPath) {
                info.executables.javac = javacPath;
                info.executables.javap = getBinaryPath(home, 'javap', executableExtension);
            }
            cb(null, info);
        }
    });
}
/**
 * Get the path to a binary in JAVA_HOME. Returns NULL if it does not exist.
 */
function getBinaryPath(home, name, executableExtension) {
    const binPath = resolvePath(home, 'bin', `${name}${executableExtension ? `.${executableExtension}` : ''}`);
    if (existsSync(binPath)) {
        return binPath;
    }
    return null;
}
/**
 * Given a path to the java executable, get the version of JAVA_HOME.
 */
function getJavaVersionAndDataModel(javaPath, cb) {
    exec(`"${javaPath}" -version`, function (err, stdout, stderr) {
        if (err) {
            return cb(err);
        }
        // TODO: Make this more robust to errors.
        const output = stderr.toString();
        const versionData = /(\d+\.\d+\.\d+)(_(\d+))?/.exec(output);
        let version = "0.0.0";
        let security = 0;
        if (versionData !== null) {
            version = versionData[1];
            security = parseInt(versionData[3], 10);
            if (isNaN(security)) {
                security = 0;
            }
        }
        return cb(err, version, security, output.toLowerCase().indexOf("64-bit") !== -1);
    });
}
export default locateJavaHome;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYXRlX2phdmFfaG9tZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3RzL2xpYi9sb2NhdGVfamF2YV9ob21lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxJQUFJLENBQUM7QUFDOUIsT0FBTyxFQUFDLE9BQU8sSUFBSSxXQUFXLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDNUMsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNuQyxPQUFPLEVBQUMsU0FBUyxJQUFJLGVBQWUsRUFBQyxNQUFNLFFBQVEsQ0FBQztBQUNwRCxPQUFPLEVBQUMsSUFBSSxJQUFJLFNBQVMsRUFBQyxNQUFNLE9BQU8sQ0FBQztBQUV4QyxPQUFPLFFBQVEsTUFBTSxZQUFZLENBQUM7QUFFbEMsTUFBTSxjQUFjLEdBQUc7SUFDckIsT0FBTyxFQUFFLEdBQUc7SUFDWixTQUFTLEVBQUUsS0FBSztJQUNoQixTQUFTLEVBQUUsS0FBSztJQUNoQixRQUFRLEVBQUUsS0FBSztJQUNmLFdBQVcsRUFBRSxLQUFLO0NBQ25CLENBQUM7QUFJRjs7R0FFRztBQUNILFNBQVMsY0FBYyxDQUFDLElBQTRCO0lBQ2xELHlCQUF5QjtJQUN6QixJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssS0FBSyxFQUFFO1FBQzFCLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDO0tBQ3BCO0lBQ0QsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDakQsQ0FBQztBQVNELFNBQVMsY0FBYyxDQUFDLElBQVMsRUFBRSxJQUEyRDtJQUM1RixJQUFJLE9BQU8sR0FBd0IsY0FBYyxDQUFDO0lBQ2xELElBQUksRUFBRSxHQUF5RCxJQUFJLENBQUM7SUFDcEUsSUFBSSxJQUFJLEVBQUU7UUFDUixFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ1YsT0FBTyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNoQztJQUVELGVBQWU7SUFDZixJQUFJLE9BQU8sQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDLFNBQVMsRUFBRTtRQUMxQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEtBQUssQ0FBQyx3RUFBd0UsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0tBQ3BHO0lBRUQsTUFBTSxjQUFjLEdBQW9CLFFBQVEsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbkUsY0FBYyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBMEIsRUFBRSxFQUFFO1FBQ25ELE1BQU0sU0FBUyxHQUFvQixFQUFFLENBQUM7UUFDdEMseUVBQXlFO1FBQ3pFLHlEQUF5RDtRQUN6RCxTQUFTLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLElBQVksRUFBRSxPQUE4QixFQUFFLEVBQUU7WUFDcEUsZUFBZSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxHQUFpQixFQUFFLFFBQXdCLEVBQUUsRUFBRTtnQkFDN0YsSUFBSSxDQUFDLEdBQUcsRUFBRTtvQkFDUix3Q0FBd0M7b0JBQ3hDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUyxDQUFDLENBQUM7b0JBQzFCLE9BQU8sRUFBRSxDQUFDO2lCQUNYO3FCQUFNLElBQUksT0FBTyxDQUFDLFFBQVEsRUFBRTtvQkFDM0IsdUNBQXVDO29CQUN2QyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ2Q7cUJBQU07b0JBQ0wsb0JBQW9CO29CQUNwQixPQUFPLEVBQUUsQ0FBQztpQkFDWDtZQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxFQUFFLENBQUMsR0FBa0IsRUFBRSxFQUFFO1lBQ3hCLElBQUksU0FBUyxHQUE4QixFQUFFLENBQUM7WUFDOUMsSUFBSSxHQUFHLEVBQUU7Z0JBQ1AsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ1Q7aUJBQU07Z0JBQ0wsRUFBRSxDQUFDLElBQUksRUFBRSxTQUFTO3FCQUNmLE1BQU0sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO29CQUNuQixvQkFBb0I7b0JBQ3BCLFFBQVEsQ0FBQyxJQUFJLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDM0MsMEJBQTBCO29CQUMxQixJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUU7d0JBQzVCLE9BQU8sS0FBSyxDQUFDO3FCQUNkO3lCQUFNO3dCQUNMLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO3FCQUNqQztvQkFFRCxpQkFBaUI7b0JBQ2pCLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQzt3QkFDM0MsaUJBQWlCOzJCQUNkLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQzt3QkFDMUMsb0JBQW9COzJCQUNqQixDQUFDLENBQUMsT0FBTyxDQUFDLFdBQVcsSUFBSSxRQUFRLENBQUMsT0FBTyxDQUFDO3dCQUM3QyxxQkFBcUI7MkJBQ2xCLGVBQWUsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDMUQsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQ2hELENBQUM7YUFDSDtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLGVBQWUsQ0FBQyxJQUFZLEVBQUUsbUJBQXVDLEVBQUUsRUFBcUQ7SUFDbkksTUFBTSxRQUFRLEdBQUcsYUFBYSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztJQUNsRSxNQUFNLFNBQVMsR0FBRyxhQUFhLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3BFLElBQUksQ0FBQyxRQUFRLEVBQUU7UUFDYixPQUFPLEVBQUUsQ0FBQyxJQUFJLEtBQUssQ0FBQyw4Q0FBOEMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0tBQzVFO0lBQ0QsMEJBQTBCLENBQUMsUUFBUSxFQUFFLENBQUMsR0FBaUIsRUFBRSxPQUFnQixFQUFFLFFBQWlCLEVBQUUsT0FBaUIsRUFBRSxFQUFFO1FBQ2pILElBQUksR0FBRyxFQUFFO1lBQ1AsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ1Q7YUFBTTtZQUNMLElBQUksSUFBSSxHQUFrQjtnQkFDeEIsSUFBSSxFQUFFLElBQUk7Z0JBQ1YsT0FBTyxFQUFFLE9BQVE7Z0JBQ2pCLFFBQVEsRUFBRSxRQUFTO2dCQUNuQixLQUFLLEVBQUUsU0FBUyxLQUFLLElBQUk7Z0JBQ3pCLE9BQU8sRUFBRSxPQUFRO2dCQUNqQixXQUFXLEVBQUU7b0JBQ1gsSUFBSSxFQUFFLFFBQVE7aUJBQ2Y7YUFDRixDQUFDO1lBRUYsSUFBSSxTQUFTLEVBQUU7Z0JBQ2IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDO2dCQUNuQyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxtQkFBbUIsQ0FBRSxDQUFDO2FBQzdFO1lBQ0QsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztTQUNoQjtJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBUyxhQUFhLENBQUMsSUFBWSxFQUFFLElBQVksRUFBRSxtQkFBNEI7SUFDN0UsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxJQUFJLEdBQUcsbUJBQW1CLENBQUMsQ0FBQyxDQUFDLElBQUksbUJBQW1CLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUMzRyxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUN2QixPQUFPLE9BQU8sQ0FBQztLQUNoQjtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBUywwQkFBMEIsQ0FBQyxRQUFnQixFQUFFLEVBQXVGO0lBQzNJLElBQUksQ0FBQyxJQUFJLFFBQVEsWUFBWSxFQUFFLFVBQVUsR0FBaUIsRUFBRSxNQUF1QixFQUFFLE1BQXVCO1FBQzFHLElBQUksR0FBRyxFQUFFO1lBQ1AsT0FBTyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDaEI7UUFDRCx5Q0FBeUM7UUFDekMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2pDLE1BQU0sV0FBVyxHQUFHLDBCQUEwQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM1RCxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdEIsSUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2pCLElBQUksV0FBVyxLQUFLLElBQUksRUFBRTtZQUN4QixPQUFPLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLFFBQVEsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3hDLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUNuQixRQUFRLEdBQUcsQ0FBQyxDQUFDO2FBQ2Q7U0FDRjtRQUNELE9BQU8sRUFBRSxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuRixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxlQUFlLGNBQWMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7ZXhpc3RzU3luY30gZnJvbSAnZnMnO1xuaW1wb3J0IHtyZXNvbHZlIGFzIHJlc29sdmVQYXRofSBmcm9tICdwYXRoJztcbmltcG9ydCB7ZXhlY30gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQge3NhdGlzZmllcyBhcyBzZW12ZXJTYXRpc2ZpZXN9IGZyb20gJ3NlbXZlcic7XG5pbXBvcnQge2VhY2ggYXMgYXN5bmNFYWNofSBmcm9tICdhc3luYyc7XG5pbXBvcnQge0lMb2NhdGVKYXZhSG9tZU9wdGlvbnMsIElKYXZhSG9tZUluZm8sIElMb2NhdGVKYXZhSG9tZSwgSUxvY2F0ZUphdmFIb21lUmVzdWx0fSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IFBsYXRmb3JtIGZyb20gJy4vcGxhdGZvcm0nO1xuXG5jb25zdCBkZWZhdWx0T3B0aW9ucyA9IHtcbiAgdmVyc2lvbjogXCIqXCIsXG4gIG11c3RCZUpESzogZmFsc2UsXG4gIG11c3RCZUpSRTogZmFsc2UsXG4gIHBhcmFub2lkOiBmYWxzZSxcbiAgbXVzdEJlNjRCaXQ6IGZhbHNlXG59O1xuXG50eXBlIFN0YW5kYXJkaXplZE9wdGlvbnMgPSBJTG9jYXRlSmF2YUhvbWVPcHRpb25zICYgdHlwZW9mIGRlZmF1bHRPcHRpb25zO1xuXG4vKipcbiAqIFJldHVybiBhbiBJTG9jYXRlSmF2YUhvbWVPcHRpb25zIG9iamVjdCB3aXRoIGRlZmF1bHRzIGZpbGxlZCBpbi5cbiAqL1xuZnVuY3Rpb24gZmlsbEluRGVmYXVsdHMob3B0czogSUxvY2F0ZUphdmFIb21lT3B0aW9ucyk6IFN0YW5kYXJkaXplZE9wdGlvbnMge1xuICAvLyBzZW12ZXIgc3RhbmRhcmRpemF0aW9uXG4gIGlmIChvcHRzLnZlcnNpb24gPT09ICdhbnknKSB7XG4gICAgb3B0cy52ZXJzaW9uID0gXCIqXCI7XG4gIH1cbiAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRPcHRpb25zLCBvcHRzKTtcbn1cblxuLyoqXG4gKiBMb2NhdGVzIGphdmEgaG9tZS5cbiAqXG4gKiBDYWxscyB0aGUgY2FsbGJhY2sgd2l0aCBhIG1hdGNoaW5nIEpBVkFfSE9NRS5cbiAqL1xuZnVuY3Rpb24gbG9jYXRlSmF2YUhvbWUoY2I6IChlcnI6IEVycm9yIHwgbnVsbCwgZm91bmQ/OiBJSmF2YUhvbWVJbmZvW10pID0+IHZvaWQpOiB2b2lkO1xuZnVuY3Rpb24gbG9jYXRlSmF2YUhvbWUob3B0aW9uczogSUxvY2F0ZUphdmFIb21lT3B0aW9ucywgY2I6IChlcnI6IEVycm9yIHwgbnVsbCwgZm91bmQ/OiBJSmF2YUhvbWVJbmZvW10pID0+IHZvaWQpOiB2b2lkO1xuZnVuY3Rpb24gbG9jYXRlSmF2YUhvbWUoYXJnMTogYW55LCBhcmcyPzogKGVycjogRXJyb3IgfCBudWxsLCBmb3VuZD86IElKYXZhSG9tZUluZm9bXSkgPT4gdm9pZCk6IHZvaWQge1xuICBsZXQgb3B0aW9uczogU3RhbmRhcmRpemVkT3B0aW9ucyA9IGRlZmF1bHRPcHRpb25zO1xuICBsZXQgY2I6IChlcnI6IEVycm9yIHwgbnVsbCwgZm91bmQ/OiBJSmF2YUhvbWVJbmZvW10pID0+IHZvaWQgPSBhcmcxO1xuICBpZiAoYXJnMikge1xuICAgIGNiID0gYXJnMjtcbiAgICBvcHRpb25zID0gZmlsbEluRGVmYXVsdHMoYXJnMSk7XG4gIH1cblxuICAvLyBTYW5pdHkgY2hlY2tcbiAgaWYgKG9wdGlvbnMubXVzdEJlSkRLICYmIG9wdGlvbnMubXVzdEJlSlJFKSB7XG4gICAgcmV0dXJuIGNiKG5ldyBFcnJvcihgVW5zYXRpc2ZpYWJsZSBvcHRpb25zOiBBIEpBVkFfSE9NRSBjYW5ub3QgYmUgYm90aCBhIEpESyBhbmQgbm90IGEgSkRLLmApLCBbXSk7XG4gIH1cblxuICBjb25zdCBsb2NhdGVKYXZhSG9tZTogSUxvY2F0ZUphdmFIb21lID0gUGxhdGZvcm0ocHJvY2Vzcy5wbGF0Zm9ybSk7XG4gIGxvY2F0ZUphdmFIb21lKCkudGhlbigocmVzOiBJTG9jYXRlSmF2YUhvbWVSZXN1bHQpID0+IHtcbiAgICBjb25zdCBob21lSW5mb3M6IElKYXZhSG9tZUluZm9bXSA9IFtdO1xuICAgIC8vIE5PVEU6IFdlIGRvbid0IHVzZSBhc3luYy5tYXAgaGVyZSBiZWNhdXNlIHdlIHdhbnQgdG8gYmUgZXJyb3IgdG9sZXJhbnRcbiAgICAvLyBpbiBjYXNlIHNvbWUgb2YgdGhlIEpBVkFfSE9NRSBsb2NhdGlvbnMgYXJlIGVycm9uZW91cy5cbiAgICBhc3luY0VhY2gocmVzLmhvbWVzLCAoaG9tZTogc3RyaW5nLCBhc3luY0NiOiAoZXJyPzogRXJyb3IpID0+IHZvaWQpID0+IHtcbiAgICAgIGdldEphdmFIb21lSW5mbyhob21lLCByZXMuZXhlY3V0YWJsZUV4dGVuc2lvbiwgKGVycjogRXJyb3IgfCBudWxsLCBob21lSW5mbz86IElKYXZhSG9tZUluZm8pID0+IHtcbiAgICAgICAgaWYgKCFlcnIpIHtcbiAgICAgICAgICAvLyBQdXNoIHRoZSBpbmZvIGFuZCBjb250aW51ZSBpdGVyYXRpb24uXG4gICAgICAgICAgaG9tZUluZm9zLnB1c2goaG9tZUluZm8hKTtcbiAgICAgICAgICBhc3luY0NiKCk7XG4gICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5wYXJhbm9pZCkge1xuICAgICAgICAgIC8vIFJlcG9ydCB0aGUgZXJyb3IsIGhhbHRpbmcgaXRlcmF0aW9uLlxuICAgICAgICAgIGFzeW5jQ2IoZXJyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBJZ25vcmUgSkFWQV9IT01FLlxuICAgICAgICAgIGFzeW5jQ2IoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSwgKGVycj86IEVycm9yIHwgbnVsbCkgPT4ge1xuICAgICAgdmFyIHNlZW5QYXRoczoge1twYXRoOiBzdHJpbmddOiBib29sZWFufSA9IHt9O1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBjYihlcnIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2IobnVsbCwgaG9tZUluZm9zXG4gICAgICAgICAgLmZpbHRlcigoaG9tZUluZm8pID0+IHtcbiAgICAgICAgICAgIC8vIEFic29sdXRlIHBhdGhpZnkuXG4gICAgICAgICAgICBob21lSW5mby5wYXRoID0gcmVzb2x2ZVBhdGgoaG9tZUluZm8ucGF0aCk7XG4gICAgICAgICAgICAvLyBGaWx0ZXIgcmVkdW5kYW50IHBhdGhzLlxuICAgICAgICAgICAgaWYgKHNlZW5QYXRoc1tob21lSW5mby5wYXRoXSkge1xuICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBzZWVuUGF0aHNbaG9tZUluZm8ucGF0aF0gPSB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBKREsgY29uc3RyYWludFxuICAgICAgICAgICAgcmV0dXJuICghb3B0aW9ucy5tdXN0QmVKREsgfHwgaG9tZUluZm8uaXNKREspXG4gICAgICAgICAgICAgIC8vIEpSRSBjb25zdHJhaW50XG4gICAgICAgICAgICAgICYmICghb3B0aW9ucy5tdXN0QmVKUkUgfHwgIWhvbWVJbmZvLmlzSkRLKVxuICAgICAgICAgICAgICAvLyA2NC1iaXQgY29uc3RyYWludFxuICAgICAgICAgICAgICAmJiAoIW9wdGlvbnMubXVzdEJlNjRCaXQgfHwgaG9tZUluZm8uaXM2NEJpdClcbiAgICAgICAgICAgICAgLy8gdmVyc2lvbiBjb25zdHJhaW50XG4gICAgICAgICAgICAgICYmIHNlbXZlclNhdGlzZmllcyhob21lSW5mby52ZXJzaW9uLCBvcHRpb25zLnZlcnNpb24pO1xuICAgICAgICAgIH0pLnNvcnQoKGEsIGIpID0+IGEucGF0aC5sb2NhbGVDb21wYXJlKGIucGF0aCkpXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufVxuXG4vKipcbiAqIEdldCB0aGUgSUphdmFIb21lSW5mbyBvYmplY3QgZm9yIHRoZSBnaXZlbiBwYXRoLlxuICovXG5mdW5jdGlvbiBnZXRKYXZhSG9tZUluZm8oaG9tZTogc3RyaW5nLCBleGVjdXRhYmxlRXh0ZW5zaW9uOiBzdHJpbmcgfCB1bmRlZmluZWQsIGNiOiAoZXJyOiBFcnJvciB8IG51bGwsIGluZm8/OiBJSmF2YUhvbWVJbmZvKSA9PiB2b2lkKTogdm9pZCB7XG4gIGNvbnN0IGphdmFQYXRoID0gZ2V0QmluYXJ5UGF0aChob21lLCAnamF2YScsIGV4ZWN1dGFibGVFeHRlbnNpb24pO1xuICBjb25zdCBqYXZhY1BhdGggPSBnZXRCaW5hcnlQYXRoKGhvbWUsICdqYXZhYycsIGV4ZWN1dGFibGVFeHRlbnNpb24pO1xuICBpZiAoIWphdmFQYXRoKSB7XG4gICAgcmV0dXJuIGNiKG5ldyBFcnJvcihgVW5hYmxlIHRvIGxvY2F0ZSAnamF2YScgZXhlY3V0YWJsZSBpbiBwYXRoICR7aG9tZX1gKSk7XG4gIH1cbiAgZ2V0SmF2YVZlcnNpb25BbmREYXRhTW9kZWwoamF2YVBhdGgsIChlcnI6IEVycm9yIHwgbnVsbCwgdmVyc2lvbj86IHN0cmluZywgc2VjdXJpdHk/OiBudW1iZXIsIGlzNjRCaXQ/OiBib29sZWFuKSA9PiB7XG4gICAgaWYgKGVycikge1xuICAgICAgY2IoZXJyKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGluZm86IElKYXZhSG9tZUluZm8gPSB7XG4gICAgICAgIHBhdGg6IGhvbWUsXG4gICAgICAgIHZlcnNpb246IHZlcnNpb24hLFxuICAgICAgICBzZWN1cml0eTogc2VjdXJpdHkhLFxuICAgICAgICBpc0pESzogamF2YWNQYXRoICE9PSBudWxsLFxuICAgICAgICBpczY0Qml0OiBpczY0Qml0ISxcbiAgICAgICAgZXhlY3V0YWJsZXM6IHtcbiAgICAgICAgICBqYXZhOiBqYXZhUGF0aFxuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBpZiAoamF2YWNQYXRoKSB7XG4gICAgICAgIGluZm8uZXhlY3V0YWJsZXMuamF2YWMgPSBqYXZhY1BhdGg7XG4gICAgICAgIGluZm8uZXhlY3V0YWJsZXMuamF2YXAgPSBnZXRCaW5hcnlQYXRoKGhvbWUsICdqYXZhcCcsIGV4ZWN1dGFibGVFeHRlbnNpb24pITtcbiAgICAgIH1cbiAgICAgIGNiKG51bGwsIGluZm8pO1xuICAgIH1cbiAgfSk7XG59XG5cbi8qKlxuICogR2V0IHRoZSBwYXRoIHRvIGEgYmluYXJ5IGluIEpBVkFfSE9NRS4gUmV0dXJucyBOVUxMIGlmIGl0IGRvZXMgbm90IGV4aXN0LlxuICovXG5mdW5jdGlvbiBnZXRCaW5hcnlQYXRoKGhvbWU6IHN0cmluZywgbmFtZTogc3RyaW5nLCBleGVjdXRhYmxlRXh0ZW5zaW9uPzogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XG4gIGNvbnN0IGJpblBhdGggPSByZXNvbHZlUGF0aChob21lLCAnYmluJywgYCR7bmFtZX0ke2V4ZWN1dGFibGVFeHRlbnNpb24gPyBgLiR7ZXhlY3V0YWJsZUV4dGVuc2lvbn1gIDogJyd9YCk7XG4gIGlmIChleGlzdHNTeW5jKGJpblBhdGgpKSB7XG4gICAgcmV0dXJuIGJpblBhdGg7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbi8qKlxuICogR2l2ZW4gYSBwYXRoIHRvIHRoZSBqYXZhIGV4ZWN1dGFibGUsIGdldCB0aGUgdmVyc2lvbiBvZiBKQVZBX0hPTUUuXG4gKi9cbmZ1bmN0aW9uIGdldEphdmFWZXJzaW9uQW5kRGF0YU1vZGVsKGphdmFQYXRoOiBzdHJpbmcsIGNiOiAoZXJyOiBFcnJvciB8IG51bGwsIHZlcnNpb24/OiBzdHJpbmcsIHNlY3VyaXR5PzogbnVtYmVyLCBpczY0Qml0PzogYm9vbGVhbikgPT4gdm9pZCkge1xuICBleGVjKGBcIiR7amF2YVBhdGh9XCIgLXZlcnNpb25gLCBmdW5jdGlvbiAoZXJyOiBFcnJvciB8IG51bGwsIHN0ZG91dDogc3RyaW5nIHwgQnVmZmVyLCBzdGRlcnI6IHN0cmluZyB8IEJ1ZmZlcikge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIHJldHVybiBjYihlcnIpO1xuICAgIH1cbiAgICAvLyBUT0RPOiBNYWtlIHRoaXMgbW9yZSByb2J1c3QgdG8gZXJyb3JzLlxuICAgIGNvbnN0IG91dHB1dCA9IHN0ZGVyci50b1N0cmluZygpO1xuICAgIGNvbnN0IHZlcnNpb25EYXRhID0gLyhcXGQrXFwuXFxkK1xcLlxcZCspKF8oXFxkKykpPy8uZXhlYyhvdXRwdXQpO1xuICAgIGxldCB2ZXJzaW9uID0gXCIwLjAuMFwiO1xuICAgIGxldCBzZWN1cml0eSA9IDA7XG4gICAgaWYgKHZlcnNpb25EYXRhICE9PSBudWxsKSB7XG4gICAgICB2ZXJzaW9uID0gdmVyc2lvbkRhdGFbMV07XG4gICAgICBzZWN1cml0eSA9IHBhcnNlSW50KHZlcnNpb25EYXRhWzNdLCAxMCk7XG4gICAgICBpZiAoaXNOYU4oc2VjdXJpdHkpKSB7XG4gICAgICAgIHNlY3VyaXR5ID0gMDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGNiKGVyciwgdmVyc2lvbiwgc2VjdXJpdHksIG91dHB1dC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoXCI2NC1iaXRcIikgIT09IC0xKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGxvY2F0ZUphdmFIb21lO1xuIl19